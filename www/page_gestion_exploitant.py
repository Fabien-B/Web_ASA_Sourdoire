template = Import('template.py' ) # import du fichier template (entete, pieds de page...)
connexion = Import('gestion_session.py')
releve = Import('releve.py')
exploitantfile = Import('Exploitant.py')
parcelle = Import('parcelle.py')
compteur = Import('compteur.py')

def index(error=''):
    ret=template.afficherHautPage(error, titre='Gérer les membres')
    if "login" in Session() and Session()['Id_exploitant']==0:
        ret += corps_page_connecte()
    else:
        ret += corps_page_deconnecte()
    ret += template.afficherBasPage()
    return ret

def corps_page_connecte():
    html = """
        <div class="container">
            <div class="sixteen columns main-content" style="text-align:center;">
                <h2>Gestion des membres</h2>
            </div>
            <aside class="six columns alpha">

                <form action="traiterListeExploitant" method="post">
                    <select id="exploitant_choice" name="idExploitant" size="10" onchange="update_info_exploitant(this,this.selectedIndex)">
            """
    html += create_select()
    html += """
                    </select>
                    <button name="choix" value="ajout">Ajouter un membre</button>
                    <button name="choix" value="modifier">Modifier ce membre</button>
                </form>
            </aside>
            """
    html+= get_details(1)
    html+="""
        </div>
    """
    return html

def get_details(id_ex):
    id_ex = int(id_ex)
    expl = exploitantfile.Exploitant(id_ex)
    tel = expl.tel if expl.tel else 'Pas de donnée'
    mail = expl.mail if expl.mail else 'Pas de donnée'
    nb_parcelles = len(parcelle.Parcelle.get_exploitant_parcelle_id(id_ex))
    html='''<p class="ten columns main-content" id="infosexploitant">
            Nom : {0} </br>
            tel:  {1} </br>
            mail: {2} </br>
            {3} parcelles
            </p>'''.format(expl.nom,tel,mail,nb_parcelles)
    return html

def corps_page_deconnecte():
    html = """
        <div class="container">
            <div class="sixteen columns main-content" style="text-align:center;">
                <h2>Vous n'avez pas accès à cette page</h2>
            </div>
        </div>
    """
    return html

def corps_page_exploitant(exploitant):
    html = template.afficherHautPage(titre='Gérer les membres')
    html += """
        <div class="container">
            <div class = "sixteen columns main-content">
                <form action="traiterFormExploitant" method="GET">
                    <div class="one-third column alpha">
                        <label>Nom du membre :</label>
                        <h3>{0}</h3>
                        <label>Changer le nom :</label>
                        <input name="nom" type="text" placeholder="Nouveau nom" />
                        <hr>
                        <label>Numéro de téléphone du membre :</label>
                        <h3>{3}</h3>
                        <label>Changer le numéro de téléphone :</label>
                        <input type="tel" name="tel" placeholder="Nouveau numéro de téléphone" />
                    </div>
                    <div class="one-third column alpha">
                        <label>Identifiant du membre :</label>
                        <h3>{1}</h3>
                        <label>Changer d'identifiant : (N'oubliez pas de lui communiquer !)</label>
                        <input name="login" type="text" maxlength=10 placeholder="Nouvel identifiant" />
                        <hr>
                        <label>Changer le mot de passe : (N'oubliez pas de lui communiquer !)</label>
                        <input name="password" type="password" placeholder="Nouveau mot de passe" />
                        <input name="password_confirm" type="password" placeholder="Confirmer le nouveau mot de passe" />
                    </div>
                    <div class="one-third column omega">
                        <label>Adresse mail du membre:</label>
                        <h3>{2}</h3>
                        <label>Changer l'adresse mail :</label>
                        <input name="email" type="email" placeholder="Nouvelle adresse mail" />
                        <hr>
    </div>
    <hr>
    <div class="two-thirds column omega offset-by-five">
    <label>Entrer votre mot de passe actuel (pour confirmation) :</label>
    <input type="password" name="old_password" placeholder="Mot de passe actuel" required />
    <input type="submit" name="submit" value="Valider" />
    </div>
    </form>
    </div>
    </div>
""".format(exploitant.nom, exploitant.login, exploitant.mail, exploitant.tel)
    html += template.afficherBasPage()
    return html

def traiterListeExploitant(choix, idExploitant=-1):
    if choix == "ajout":
        exploitant = exploitantfile.Exploitant(-1)
        return corps_page_exploitant(exploitant)
    elif idExploitant == -1:
        return index(error="Veuillez d'abord choisir un membre dans la liste")
    else:
        if choix=="modifier":
            exploitant=exploitantfile.Exploitant(int(idExploitant))
            return corps_page_exploitant(exploitant)




def create_select():
    html = """
    """
    exploitant_list = exploitantfile.Exploitant.get_all_exploitants()
    for exploitant in exploitant_list:
        html+='<option value="'+str(exploitant.id)+'">'+str(exploitant.id)+' - '+exploitant.nom+'</option>'
    return html

def traiterFormulaireConnexion(choix, login='',password=''):
    return connexion.Connexion(index, choix, login, password)
